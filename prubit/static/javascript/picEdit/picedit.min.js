!function(a,b,c,d){"use strict";function g(b,c){this.inputelement=b,this.element=b,this.options=a.extend({},f,c),this._defaults=f,this._name=e,this._image=!1,this._filename="",this._variables={},this._template()}var e="picEdit",f={imageUpdated:function(a){},formSubmitted:function(a){},fileNameChanged:function(a){},fileLoaded:function(a){},redirectUrl:!1,maxWidth:1e3,maxHeight:"auto",aspectRatio:!0,defaultImage:!1,defaultMessageTimeout:3e3};g.prototype={init:function(){function f(a){if(a||a.length){var b=a[0];d._filename||(d._filename=b.name);var c=new FileReader;c.onload=function(a){d._create_image_with_datasrc(a.target.result,!1,b),d.options.fileLoaded(b),b.name!=d._filename&&(d._filename=b.name,d.options.fileNameChanged(b.name))},c.readAsDataURL(b)}}var d=this,e=a(this.inputelement).prop("type");if("file"==e?this._fileinput=a(this.inputelement):(a(this.inputelement).after('<input type="file" style="display:none" accept="image/*">'),this._fileinput=a(this.inputelement).next("input")),!this.check_browser_capabilities())return"file"!=e&&(a(this.inputelement).prop("type","file"),a(this._fileinput).remove()),a(this.inputelement).show(),void a(this.element).remove();if(this._canvas=a(this.element).find(".picedit_canvas > canvas")[0],this._ctx=this._canvas.getContext("2d"),this._videobox=a(this.element).find(".picedit_video"),this._painter=a(this.element).find(".picedit_painter"),this._painter_canvas=this._painter.children("canvas")[0],this._painter_ctx=this._painter_canvas.getContext("2d"),this._painter_painting=!1,this._messagebox=a(this.element).find(".picedit_message"),this._messagetimeout=!1,this._mainbuttons=a(this.element).find(".picedit_action_btns"),this._viewport={width:0,height:0},this._cropping={is_dragging:!1,is_resizing:!1,left:0,top:0,width:0,height:0,cropbox:a(this.element).find(".picedit_drag_resize"),cropframe:a(this.element).find(".picedit_drag_resize_box")},a(this.element).find(".picedit_canvas_box").on("drop",function(b){b.preventDefault(),a(this).removeClass("dragging");var c=(b.dataTransfer||b.originalEvent.dataTransfer).files;f(c)}).on("dragover",function(b){b.preventDefault(),a(this).addClass("dragging")}).on("dragleave",function(b){b.preventDefault(),a(this).removeClass("dragging")}),a(this._fileinput).on("change",function(){f(this.files)}),!b.Clipboard){var g=a(c.createElement("div"));g.prop("contenteditable","true").css({position:"absolute",left:-999,width:0,height:0,overflow:"hidden",outline:0,opacity:0}),a(c.body).prepend(g)}a(c).on("paste",function(a){var c,b=(a.clipboardData||a.originalEvent.clipboardData).items;if(b){for(var e=0;e<b.length;e++)0===b[e].type.indexOf("image")&&(c=b[e].getAsFile());if(c){var f=new FileReader;f.onload=function(a){d._create_image_with_datasrc(a.target.result)},f.readAsDataURL(c)}}else g.get(0).focus(),g.on("DOMSubtreeModified",function(){var a=g.children().last().get(0);g.html(""),a&&("IMG"===a.tagName&&"data:"==a.src.substr(0,5)?d._create_image_with_datasrc(a.src):"IMG"===a.tagName&&"http"==a.src.substr(0,4)&&d._create_image_with_datasrc(a.src,!1,!1,!0))})}),this._theformdata=!1,this._theform=a(this.inputelement).parents("form"),this._theform.length&&this._theform.on("submit",function(){return d._formsubmit()}),this._bindControlButtons(),this._bindInputVariables(),this._bindSelectionDrag(),this._variables.pen_color="black",this._variables.pen_size=!1,this._variables.prev_pos=!1,this.options.defaultImage&&d.set_default_image(this.options.defaultImage)},check_browser_capabilities:function(){return 0!=!!b.CanvasRenderingContext2D&&!!b.FileReader},set_default_image:function(a){this._create_image_with_datasrc(a,!1,!1,!0);var b=a.match(/.*\/(.+?)[\?#]/);b&&b.length>1?this._filename=b[1]:this._filename=a,this.options.fileNameChanged(this._filename)},hide_messagebox:function(){var a=this._messagebox;a.removeClass("active no_close_button"),setTimeout(function(){a.children("div").html("")},200)},set_loading:function(a){return a&&1==a?this.set_messagebox("Working...",!1,!1):this.set_messagebox("Please Wait...",!1,!1)},set_messagebox:function(a,b,c){if(b="undefined"!=typeof b?b:this.options.defaultMessageTimeout,c="undefined"==typeof c||c,this._messagebox.addClass("active"),c?this._messagebox.removeClass("no_close_button"):this._messagebox.addClass("no_close_button"),b){clearTimeout(this._messagetimeout);var d=this;this._messagetimeout=setTimeout(function(){d.hide_messagebox()},b)}return this._messagebox.children("div").html(a)},toggle_button:function(b){if(a(b).hasClass("active")){var c=!1;a(b).removeClass("active")}else{var c=!0;a(b).siblings().removeClass("active"),a(b).addClass("active")}var d=a(b).data("variable");if(d){var e=a(b).data("value");e||(e=a(b).val()),e&&c&&(c=e),this._setVariable(d,c)}this._variables.pen_color&&this._variables.pen_size?this.pen_tool_open():this.pen_tool_close()},load_image:function(){this._fileinput.click()},pen_tool_open:function(){return this._image?(this.pen_tool_params_set(),this._painter.addClass("active"),void this._hideAllNav()):this._hideAllNav(1)},pen_tool_params_set:function(){this._painter_canvas.width=0,this._painter_canvas.width=this._canvas.width,this._painter_canvas.height=this._canvas.height,this._painter_ctx.lineJoin="round",this._painter_ctx.lineCap="round",this._painter_ctx.strokeStyle=this._variables.pen_color,this._painter_ctx.lineWidth=this._variables.pen_size},pen_tool_close:function(){this._painter.removeClass("active")},rotate_ccw:function(){if(!this._image)return this._hideAllNav(1);var a=this;this.set_loading(1).delay(200).promise().done(function(){a._doRotation(-90),a._resizeViewport(),a.hide_messagebox()}),this._hideAllNav()},rotate_cw:function(){if(!this._image)return this._hideAllNav(1);var a=this;this.set_loading(1).delay(200).promise().done(function(){a._doRotation(90),a._resizeViewport(),a.hide_messagebox()}),this._hideAllNav()},resize_image:function(){if(!this._image)return this._hideAllNav(1);var a=this;this.set_loading(1).delay(200).promise().done(function(){var b=c.createElement("canvas"),d=b.getContext("2d");b.width=a._variables.resize_width,b.height=a._variables.resize_height,d.drawImage(a._image,0,0,b.width,b.height),a._create_image_with_datasrc(b.toDataURL("image/png"),function(){a.hide_messagebox()})}),this._hideAllNav()},camera_open:function(){var a,b=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(!b)return this.set_messagebox("Sorry, your browser doesn't support WebRTC!");var c=this;(a=b.bind(navigator))({audio:!1,video:!0},function(a){var b=c._videobox.find("video")[0];b.src=URL.createObjectURL(a),b.onloadedmetadata=function(){b.videoWidth&&b.videoHeight&&(c._image||(c._image={}),c._image.width=b.videoWidth,c._image.height=b.videoHeight,c._resizeViewport())},c._videobox.addClass("active")},function(a){return c.set_messagebox("No video source detected! Please allow camera access!")})},camera_close:function(){this._videobox.removeClass("active")},take_photo:function(){var a=this,b=this._videobox.find("video")[0],d=c.createElement("canvas"),e=d.getContext("2d");d.width=b.clientWidth,d.height=b.clientHeight,e.drawImage(b,0,0,d.width,d.height),this._create_image_with_datasrc(d.toDataURL("image/png"),function(){a._videobox.removeClass("active")})},crop_image:function(){var a=this._calculateCropWindow(),b=this;this.set_loading(1).delay(200).promise().done(function(){var d=c.createElement("canvas"),e=d.getContext("2d");d.width=a.width,d.height=a.height,e.drawImage(b._image,a.left,a.top,a.width,a.height,0,0,a.width,a.height),b._create_image_with_datasrc(d.toDataURL("image/png"),function(){b.hide_messagebox()})}),this.crop_close()},crop_open:function(){return this._image?(this._cropping.cropbox.addClass("active"),void this._hideAllNav()):this._hideAllNav(1)},crop_close:function(){this._cropping.cropbox.removeClass("active")},_create_image_with_datasrc:function(a,b,d,e){var f=this,g=c.createElement("img");e&&g.setAttribute("crossOrigin","anonymous"),d&&(g.file=d),g.src=a,g.onload=function(){if(e){var a=c.createElement("canvas"),d=a.getContext("2d");a.width=g.width,a.height=g.height,d.drawImage(g,0,0),g.src=a.toDataURL("image/png")}f._image=g,f._resizeViewport(),f._paintCanvas(),f.options.imageUpdated(f._image),f._mainbuttons.removeClass("active"),b&&"function"==typeof b&&b(),g.onload=null}},_bindSelectionDrag:function(){var c=this,d=this._cropping.cropframe,e=this._painter,f=this._cropping.cropbox.find(".picedit_drag_resize_box_corner_wrap");a(b).on("mousedown touchstart",function(a){var b=a.clientX?a:a.originalEvent.touches[0];c._cropping.x=b.clientX,c._cropping.y=b.clientY,c._cropping.w=d[0].clientWidth,c._cropping.h=d[0].clientHeight,d.on("mousemove touchmove",function(a){a.stopPropagation(),a.preventDefault(),c._cropping.is_dragging=!0,c._cropping.is_resizing||c._selection_drag_movement(a)}),f.on("mousemove touchmove",function(a){a.stopPropagation(),a.preventDefault(),c._cropping.is_resizing=!0,c._selection_resize_movement(a)}),e.on("mousemove touchmove",function(a){a.stopPropagation(),a.preventDefault(),c._painter_painting=!0,c._painter_movement(a)})}).on("mouseup touchend",function(){c._painter_painting&&c._painter_merge_drawing(),c._cropping.is_dragging=!1,c._cropping.is_resizing=!1,c._painter_painting=!1,c._variables.prev_pos=!1,d.off("mousemove touchmove"),f.off("mousemove touchmove"),e.off("mousemove touchmove")})},_selection_resize_movement:function(a){var b=this._cropping.cropframe[0],c=a.clientX?a:a.originalEvent.touches[0];b.style.width=this._cropping.w+c.clientX-this._cropping.x+"px",b.style.height=this._cropping.h+c.clientY-this._cropping.y+"px"},_selection_drag_movement:function(a){var b=this._cropping.cropframe[0],c=a.pageX?a:a.originalEvent.touches[0];this._cropping.cropframe.offset({top:c.pageY-parseInt(b.clientHeight/2,10),left:c.pageX-parseInt(b.clientWidth/2,10)})},_painter_movement:function(a){var b={},c=a.target||a.srcElement,d=c.getBoundingClientRect(),e=a.clientX?a:a.originalEvent.touches[0];return b.x=e.clientX-d.left,b.y=e.clientY-d.top,this._variables.prev_pos?(this._painter_ctx.beginPath(),this._painter_ctx.moveTo(this._variables.prev_pos.x,this._variables.prev_pos.y),this._painter_ctx.lineTo(b.x,b.y),this._painter_ctx.stroke(),void(this._variables.prev_pos=b)):this._variables.prev_pos=b},_painter_merge_drawing:function(){var a=c.createElement("canvas"),b=a.getContext("2d"),d=this;a.width=this._image.width,a.height=this._image.height,b.drawImage(this._image,0,0,a.width,a.height),b.drawImage(this._painter_canvas,0,0,a.width,a.height),a.width>1280&&a.height>800?this.set_loading().delay(200).promise().done(function(){d._create_image_with_datasrc(a.toDataURL("image/png"),function(){d.pen_tool_params_set(),d.hide_messagebox()})}):this._create_image_with_datasrc(a.toDataURL("image/png"),function(){d.pen_tool_params_set()})},_hideAllNav:function(b){b&&1==b&&this.set_messagebox("Open an image or use your camera to make a photo!"),a(this.element).find(".picedit_nav_box").removeClass("active").find(".picedit_element").removeClass("active")},_paintCanvas:function(){this._canvas.width=this._viewport.width,this._canvas.height=this._viewport.height,this._ctx.drawImage(this._image,0,0,this._viewport.width,this._viewport.height),a(this.element).find(".picedit_canvas").css("display","block")},_calculateCropWindow:function(){var a=this._viewport,b=this._cropping.cropframe[0],c={width:this._image.width,height:this._image.height},d={width:b.clientWidth,height:b.clientHeight,top:b.offsetTop>0?b.offsetTop:.1,left:b.offsetLeft>0?b.offsetLeft:.1};d.width+d.left>a.width&&(d.width=a.width-d.left),d.height+d.top>a.height&&(d.height=a.height-d.top);var e=d.width/a.width,f=d.height/a.height,g={width:parseInt(c.width*e,10),height:parseInt(c.height*f,10)},h=d.top/a.height,i=d.left/a.width;return g.top=parseInt(c.height*h,10),g.left=parseInt(c.width*i,10),g},_doRotation:function(a){var d,e,b=a*Math.PI/180,f=Math.cos(b),g=Math.sin(b);g<0&&(g=-g),f<0&&(f=-f),d=this._image.height*g+this._image.width*f,e=this._image.height*f+this._image.width*g;var h=c.createElement("canvas"),i=h.getContext("2d");h.width=parseInt(d,10),h.height=parseInt(e,10);var j=h.width/2,k=h.height/2;i.clearRect(0,0,h.width,h.height),i.translate(j,k),i.rotate(b),i.drawImage(this._image,-this._image.width/2,-this._image.height/2),this._image.src=h.toDataURL("image/png"),this._paintCanvas(),this.options.imageUpdated(this._image)},_resizeViewport:function(){var b=this._image,c={width:b.width,height:b.height};if("auto"!=this.options.maxWidth&&b.width>this.options.maxWidth&&(c.width=this.options.maxWidth),"auto"!=this.options.maxHeight&&b.height>this.options.maxHeight&&(c.height=this.options.maxHeight),this.options.aspectRatio){var d=b.width,e=b.height,f=d/e;d>c.width&&(c.width=parseInt(c.width,10),c.height=parseInt(c.width/f,10)),e>c.height&&(f=d/e,c.height=parseInt(c.height,10),c.width=parseInt(c.height*f,10))}a(this.element).css({width:c.width,height:c.height}),this._viewport=c,this._setVariable("resize_width",b.width),this._setVariable("resize_height",b.height)},_bindControlButtons:function(){var b=this;a(this.element).find(".picedit_control").bind("click",function(){var c=a(this).data("action");c?b[c](this):a(this).hasClass("picedit_action")&&(a(this).parent(".picedit_element").toggleClass("active").siblings(".picedit_element").removeClass("active"),a(this).parent(".picedit_element").hasClass("active")?a(this).closest(".picedit_nav_box").addClass("active"):a(this).closest(".picedit_nav_box").removeClass("active"))})},_bindInputVariables:function(){var b=this;a(this.element).find(".picedit_input").bind("change keypress paste input",function(){var c=a(this).data("variable");if(c){var d=a(this).val();b._variables[c]=d}if(("resize_width"==c||"resize_height"==c)&&b._variables.resize_proportions){var e=b._image.width/b._image.height;"resize_width"==c?b._setVariable("resize_height",parseInt(d/e,10)):b._setVariable("resize_width",parseInt(d*e,10))}})},_setVariable:function(b,c){this._variables[b]=c,a(this.element).find('[data-variable="'+b+'"]').val(c)},_formsubmit:function(){if(b.FormData){var c=this;this.set_loading().delay(200).promise().done(function(){if(c._theformdata=new FormData(c._theform[0]),c._image){var d=a(c.inputelement).prop("name")||"file",e=c._dataURItoBlob(c._image.src);c._filename?c._filename=c._filename.match(/^[^\.]*/)+"."+e.type.match(/[^\/]*$/):c._filename=e.type.replace("/","."),c._theformdata.append(d,e,c._filename)}var f=new XMLHttpRequest;f.onprogress=function(a){if(a.lengthComputable)var b=a.total;else var b=Math.ceil(1.3*e.size);var d=Math.ceil(a.loaded/b*100);d>100&&(d=100),c.set_messagebox("Please Wait... Uploading... "+d+"% Uploaded.",!1,!1)},f.open(c._theform.prop("method"),c._theform.prop("action"),!0),f.onload=function(a){200!=this.status?c.set_messagebox("Server did not accept data!"):c.options.redirectUrl===!0?b.location.reload():c.options.redirectUrl?b.location=c.options.redirectUrl:c.set_messagebox("Data successfully submitted!"),c.options.formSubmitted(this)},f.send(c._theformdata)})}else this.set_messagebox("Sorry, the FormData API is not supported!");return!1},_dataURItoBlob:function(a){if(!a)return null;for(var b=a.match(/^data\:(.+?)\;/),c=atob(a.split(",")[1]),d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++)e[f]=c.charCodeAt(f);return new Blob([d],{type:b[1]})},_template:function(){var b='<div class="picedit_box"> <div class="picedit_message"> <span class="picedit_control ico-picedit-close" data-action="hide_messagebox"></span> <div></div></div><div class="picedit_nav_box picedit_gray_gradient"> <div class="picedit_pos_elements"></div><div class="picedit_nav_elements"><div class="picedit_element"> <div class="picedit_control_menu"> <div class="picedit_control_menu_container picedit_tooltip picedit_elm_3"> <label class="picedit_colors"></label> <label> <span class="picedit_separator"></span> </label> <label class="picedit_sizes"></span> </label> </div></div></div><div class="picedit_element"><span class="picedit_control picedit_action ico-picedit-insertpicture" title="Crop" data-action="crop_open"></span> </div><div class="picedit_element"> <span class="picedit_control picedit_action ico-picedit-redo" title="Rotate"></span> <div class="picedit_control_menu"> <div class="picedit_control_menu_container picedit_tooltip picedit_elm_1"> <label> <span>90° CW</span> <span class="picedit_control picedit_action ico-picedit-redo" data-action="rotate_cw"></span> </label> <label> <span>90° CCW</span> <span class="picedit_control picedit_action ico-picedit-undo" data-action="rotate_ccw"></span> </label> </div></div></div><div class="picedit_element"> <span class="picedit_control picedit_action ico-picedit-arrow-maximise" title="Resize"></span> <div class="picedit_control_menu"> <div class="picedit_control_menu_container picedit_tooltip picedit_elm_2"> <label><span class="picedit_control picedit_action ico-picedit-checkmark" data-action="resize_image"></span><span class="picedit_control picedit_action ico-picedit-close" data-action=""></span> </label> <label> <span>Ancho (px) (max: XX)</span> <input type="text" class="picedit_input" data-variable="resize_width" value="0"> </label> <label class="picedit_nomargin"> <span class="picedit_control ico-picedit-link" data-action="toggle_button" data-variable="resize_proportions"></span> </label> <label> <span>Altura (px) (max: XX)</span> <input type="text" class="picedit_input" data-variable="resize_height" value="0"> </label> </div></div></div></div></div><div class="picedit_canvas_box"><div class="picedit_painter"><canvas></canvas></div><div class="picedit_canvas"><canvas></canvas></div><div class="picedit_action_btns active"> <div class="picedit_control ico-picedit-picture" data-action="load_image"></div><div class="center">or copy/paste image here</div></div></div><div class="picedit_video"> <video autoplay></video><div class="picedit_video_controls"><span class="picedit_control picedit_action ico-picedit-checkmark" data-action="take_photo"></span></div></div><div class="picedit_drag_resize"> <div class="picedit_drag_resize_canvas"></div><div class="picedit_drag_resize_box"><div class="picedit_drag_resize_box_corner_wrap"> <div class="picedit_drag_resize_box_corner"></div></div><div class="picedit_drag_resize_box_elements"><span class="picedit_control picedit_action ico-picedit-checkmark" data-action="crop_image"></span><span class="picedit_control picedit_action ico-picedit-close" data-action="crop_close"></span></div></div></div></div>',c=this;a(this.inputelement).hide().after(b).each(function(){c.element=a(c.inputelement).next(".picedit_box"),c.init()})}},a.fn[e]=function(b){var c=arguments;if(b===d||"object"==typeof b)return this.each(function(){a.data(this,"plugin_"+e)||a.data(this,"plugin_"+e,new g(this,b))});if("string"==typeof b&&"_"!==b[0]&&"init"!==b){var f;return this.each(function(){var d=a.data(this,"plugin_"+e);d instanceof g&&"function"==typeof d[b]&&(f=d[b].apply(d,Array.prototype.slice.call(c,1))),"destroy"===b&&a.data(this,"plugin_"+e,null)}),f!==d?f:this}}}(jQuery,window,document);